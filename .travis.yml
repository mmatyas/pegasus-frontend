language: cpp

sudo: required
dist: trusty

branches:
  only:
  - master

env:
  global:
  - TOOLS_URL=https://github.com/mmatyas/pegasus-frontend/releases/download/alpha1
  - QT_VER=qt594
  - PEGASUS_HOME=/hello/world
  matrix:
  - TARGET=x11-static
  - TARGET=rpi1-static CROSS=1
  - TARGET=rpi2-static CROSS=1

git:
  depth: 100

before_install:
  - pushd /tmp
  - wget ${TOOLS_URL}/${QT_VER}_${TARGET}.txz
  - if [[ -n "$CROSS" ]]; then wget ${TOOLS_URL}/rpi-toolchain_483.txz; fi
  - if [[ -n "$CROSS" ]]; then wget ${TOOLS_URL}/rpi-sysroot_jessie_2017-07-05.txz; fi
  - for f in *.txz; do sudo tar xJf ${f} -C /opt/; done
  - if [[ "$TARGET" == "x11-static" ]]; then
      sudo ln -s ${QT_VER}_${TARGET} /opt/${QT_VER}_${TARGET}_hosttools;
      sudo apt-get -qq update &&
      sudo apt-get install -y
        libasound-dev
        libgstreamer-plugins-base1.0-dev
        libpulse-dev
        libudev-dev
        libxi-dev
      ;
    fi
  - sudo mkdir /opt/pegasus-frontend
  - sudo chown travis:travis /opt/pegasus-frontend
  - popd

before_script:
  - if [[ $TARGET == x11* ]]; then
      export DISPLAY=:99.0;
      sh -e /etc/init.d/xvfb start;
      sleep 3;
    fi

script:
  - if [[ $TARGET == x11* ]]; then
      find -name *.qml -exec /opt/${QT_VER}_${TARGET}/bin/qmllint {} \; ;
    fi
  - mkdir build && cd build
  - /opt/${QT_VER}_${TARGET}_hosttools/bin/qmake ..
  - make
  - if [[ $TARGET == x11* ]]; then make check; fi
  - make install

after_success:
  - export SUFFIX=$(git describe --always)_${TARGET}
  - zip -j pegasus-fe_${SUFFIX}.zip
      /opt/pegasus-frontend/pegasus-fe
      ../README.md
      ../LICENSE.md
  - curl --upload-file
      pegasus-fe_${SUFFIX}.zip
      https://transfer.sh/pegasus-fe_${SUFFIX}.zip
  - wget -c https://github.com/mmatyas/uploadtool/raw/master/upload.sh
  - bash ./upload.sh pegasus-fe_${SUFFIX}.zip

matrix:
  fast_finish: true
  allow_failures:
    # OSX build
    - os: osx
      compiler: clang
      env: null
      before_install:
        - brew update
      install:
        - brew install qt5
        - brew link --force qt5
        - qmake -v
      script:
        - mkdir build && cd build
        - qmake ..
        - make check
      after_success:
        - true
  include:
    # Qt 5.7.1 (for Debian Stretch/Ubuntu Zesty)
    - env: QT_QPA_PLATFORM=minimal
      before_install:
        - sudo add-apt-repository -y ppa:beineri/opt-qt571-trusty
        - sudo apt-get update
      install:
        - sudo apt-get install -y
            lcov
            qt57declarative
            qt57graphicaleffects
            qt57gamepad
            qt57imageformats
            qt57multimedia
            qt57svg
            qt57tools
        - source /opt/qt57/bin/qt57-env.sh
        - qmake -v
        - gem install coveralls-lcov
      script:
        - mkdir build && cd build
        - qmake ..
            QMAKE_CXXFLAGS="-g -O0 --coverage -fprofile-arcs -ftest-coverage"
            QMAKE_LDFLAGS="-g -O0 --coverage -fprofile-arcs -ftest-coverage"
            LIBS+="-lgcov"
            CONFIG+=debug
        - make
        - lcov --compat-libtool -i -c -d . -o coverage.pre
        - make check
      after_success:
        - lcov --compat-libtool -c -d . -o coverage.post
        - lcov --compat-libtool -a coverage.pre -a coverage.post -o coverage.total
        - lcov --compat-libtool -r coverage.total
            '/usr/*' '/opt/*' '*/moc_*' '*/qrc_*' '*/test_*' 'src/app/*'
            -o coverage.clean
        - sed -i 's|SF:/home/travis/build/mmatyas/pegasus-frontend/|SF:|g' coverage.clean
        - cd ..
        - coveralls-lcov build/coverage.clean
